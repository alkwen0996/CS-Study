# 조인의 원리

태그: 데이터베이스 - 조인의 종류와 원리

### 조인수행원리

조인이란 두 개 이상의 테이블을 하나의 집합으로 만드는 연산이다. SQL문에서 FROM 절에 두 개 이상의 테이블이 나열될 경우 조인이 수행된다. 조인 연산은 두 테이블 사이에서 수행된다. FROM 절에 A, B, C라는 세 개의 테이블이 존재하더라도 세 개의 테이블이 동시에 조인이 수행되는 것은 아니다. 세 개의 테이블 중에서 먼저 두 개의 테이블에 대해 조인이 수행된다. 그리고 먼저 수행된 조인 결과와 나머지 테이블 사이에서 조인이 수행된다. 이러한 작업은 FROM 절에 나열된 모든 테이블을 조인할 때까지 반복 수행한다. 예를 들어, A, B, C 세 개의 테이블을 조인할 때를 가정으로 설명하면 다음과 같다. 먼저 A와 B 두 테이블을 먼저 조인하면 해당 조인 결과와 나머지 C 테이블을 조인한다(A → B → C). 만약, A와 C 테이블을 먼저 조인한다면 해당 조인 결과와 나머지 B 테이블을 조인한다(A → C → B). 테이블 또는 조인 결과를 이용하여 조인을 수행할 때 조인 단계별로 다른 조인 기법을 사용할 수 있다. 예를 들어, A와 B 테이블을 조인할 때는 NL Join 기법을 사용하고 해당 조인 결과와 C 테이블을 조인할 때는 Hash Join 기법을 사용할 수 있다. 조인 기법은 두 개의 테이블을 조인할 때 사용할 수 있는 방법이다.

### 중첩 루프 조인 (Nested Loop Join, NL Join)

프로그래밍에서 사용하는 중첩된 반복문과 유사한 원리로 조건에 맞는 조인을 하는 방법이다. 반복문의 외부에 있는 테이블을 선행 테이블 또는 외부테이블이라고 하고, 반복문의 내부에 있는 테이블을 후행 테이블 또는 내부테이블이라고 한다. 

먼저, 선행 테이블의 조건을 만족하는 행을 추출하여 후행 테이블을 읽으면서 조인을 수행한다. (이 작업은 선행 테이블의 조건을 만족하는 모든 행의 수만큼 반복수행한다.) NL Join에서는 선행 테이블의 조건을 만족하는 행의 수가 많으면 그 만큼 후행 테이블의 조인 작업은 반복 수행된다. 따라서, 결과 행의 수가 적은 테이블을 조인 순서상 선행 테이블로 선택하는 것이 전체 일량을 줄일 수 있다. NL Join은 랜덤 방식으로 데이터를 액세스하기 때문에 처리범위가 적은것이 유리하다.

**[중첩 루프 조인 작업 방법]**

```sql
FOR 선행 테이블 읽음 -> FOR 후행 테이블 읽음 -> 선행 테이블과 후행 테이블 조인
```

```sql
// 중첩루프조인 수도코드 
for each row in a matching reference key {
	for each row in b matching reference key {
		if row satisfied join conditions, send to client
	}
}
```

1.  선행 테이블에서 조건을 만족하는 첫 번째 행을 찾음 → 이때 선행 테이블에 주어진 조건을 만족하지 않는 경우 해당 데이터는 필터링 됨 
2.  선행 테이블의 조인 키를 가지고 후행 테이블에 조인 키가 존재하는지 찾으러 감 → 조인 시도 
3.  후행 테이블의 인덱스에 선행 테이블의 조인 키가 존재하는지 확인 → 선행 테이블의 조인 값이 후행 테이블에 존재하지 않으면 선행 테이블 데이터는 필터링 됨 (더 이상 조인 작업을 진행할 필요 없음) 
4.  인덱스에서 추출한 레코드 식별자를 이용하여 후행 테이블을 액세스 → 인덱스 스캔을 통한 테이블 액세스 후행 테이블에 주어진 조건까지 모두 만족하면 해당 행을 추출버퍼에 넣음 
5.  앞의 작업을 반복 수행함

> **추출버퍼**
SQL문의 실행결과를 보관하는 버퍼로서 일정 크기를 설정하여 추출버퍼에 결과가 모두 차거나 더 이상 결과가 없어서 추출버퍼를 채울 것이 없으면 결과를 사용자에게 반환한다.
> 

### 정렬 병합 조인 (Sort Merge Join)

각 테이블을 조인할 컬럼을 기준으로 정렬한 후 조인을 수행하는 조인 방법이다. 하지만, 정렬할 데이터가 많아 메모리에서 모든 정렬 작업을 수행하기 어려운 경우에는 디스크를 사용하기 때문에 성능이 떨어질 수 있다. 일반적으로 대량의 조인 작업에서 정렬 작업을 필요로 하는 경우 CPU 작업 위주로 처리하는 Hash Join이 성능상 유리하다. 하지만, 정렬 병합 조인은 Hash Join과는 달리 동등 조인 뿐만 아니라 비 동등 조인 즉, 비교 연산자가 조인조건을 경우에 대해서도 조인 작업이 가능하다는 장점이 있다.

정렬 병합 조인은 조인 컬럼의 인덱스를 사용하지 않기 때문에 조인 컬럼의 인덱스가 존재하지 않을 경우에도 사용할 수 있는 기법이다. 조인 병합 정렬에서 조인 작업을 위해 항상 정렬 작업이 발생하는 것은 아니다. 만약, 조인할 테이블 중에서 이미 앞 단계의 작업을 수행하면서 정렬 작업이 수행되었다면 조인을 위한 정렬 작업은 발생하지 않을 수 있다.

**[조인 병합 정렬 작업과정]**

1. 선행 테이블에서 주어진 조건을 만족하는 행을 찾음 
2. 선행 테이블의 조인 키를 기준으로 정렬 작업을 수행 1 ~ 2번 작업을 선행 테이블의 조건을 만족하는 모든 행에 대해 반복 수행 
3. 후행 테이블에서 주어진 조건을 만족하는 행을 찾음 
4. 후행 테이블의 조인 키를 기준으로 정렬 작업을 수행 3 ~ 4번 작업을 후행 테이블의 조건을 만족하는 모든 행에 대해 반복 수행 
5. 정렬된 결과를 이용하여 조인을 수행하며 조인에 성공하면 추출버퍼에 넣음

### 해시조인 (Hash Join)

해시 조인은 해시 기법을 이용하여 조인을 수행한다. 조인을 수행할 테이블의 조인 컬럼을 기준으로 해시 함수를 수행하여 서로 동일한 해쉬 값을 갖는 것들 사이에서 실제 값이 같은지를 비교하면서 조인 작업을 진행한다. 해시 조인은 NL Join의 랜덤 액세스 문제점과 조인 병합 정렬의 문제점인 정렬 작업의 부담을 해결하기 위한 대안으로 등장했다. 

해시 조인은 조인 컬럼의 인덱스를 사용하지 않기 때문에 조인 컬럼의 인덱스가 존재하지 않아도 사용할 수 있다. 또한 해시 함수를 이용하여 조인을 수행하기 때문에 동등(=) 조인에서만 사용할 수 있다. 그 이유는 해시 함수를 적용한 값은 어떤 값으로 해시될 지 알 수 없다. 해시 함수가 적용될 때 동일한 값은 항상 같은 값으로 해싱이 보장된다. 그러나 해시 함수를 적용할 때 보다 큰 값이 항상 큰값으로 해싱되고 작은값이 항상 작은 값으로 해싱된다는 보장은 없다. 따라서 해시 조인은 동증 조인에서만 사용할 수 있다.

해시 조인은 작업을 수행하기 위해 해시 테이블을 메모리에 생성해야 한다. 생성된 해쉬 테이블의 크기가 메모리에 적재할 수 있는 크기보다 커지면 디스크에 해시 테이블을 저장한다. 그러면 추가적인 작업이 필요해진다. 떄문에 해시 조인은 결과 행의 수가 적은 테이블을 선행 테이블로 사용하는 것이 좋다. 선행 테이블의 결과를 완전히 메모리에 저장할 수 있다면 디스크에 저장하는 작업이 발생하지 않기 때문이다. 

해시 조인에서는 선행 테이블을 이용해서 먼저 해시 테이블을 생성한다고 해서 선행 테이블을 Build Input 이라고도 하며 후행 테이블은 만들어진 해시 테이블에 대해 해쉬 값의 존재 여부를 검사한다고 해서 Prove Input 이라고도 한다.

**[해시 조인 작업과정]**

1. 선행 테이블에서 주어진 조건을 만족하는 행을 찾음 
2. 선행 테이블의 조인 키를 기준으로 해쉬 함수를 적용하여 해쉬 테이블을 생성 → 조인 칼럼과 SELECT 절에서 필요로 하는 칼럼도 함께 저장됨 
3. 1 ~ 2번 작업을 선행 테이블의 조건을 만족하는 모든 행에 대해 반복 수행 
4. 후행 테이블에서 주어진 조건을 만족하는 행을 찾음 
5. 후행 테이블의 조인 키를 기준으로 해쉬 함수를 적용하여 해당 버킷을 찾음 → 조인 키를 이용해서 실제 조인될 데이터를 찾음 
6. 조인에 성공하면 추출버퍼에 넣음 
7. 3 ~ 5번 작업을 후행 테이블의 조건을 만족하는 모든 행에 대해서 반복 수행

> **버킷(bucket)**

해시 테이블은 각각의 Key 값에 따라 해시 함수를 적용해 배열의 고유한 Index를 생성하고 이 Index를 활용해 값을 저장하거나 검색하게 된다. 여기서 실제 값이 저장되는 장소를 버킷 또는 슬롯이라고 한다.
> 

### [Reference]

[조인 수행 원리](https://dataonair.or.kr/db-tech-reference/d-guide/sql/?mod=document&uid=356)
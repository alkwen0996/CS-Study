## Transaction

---

### 데이터베이스 트랜잭션 ( Transaction )

데이터베이스에서 트랜잭션이란 데이터베이스의 상태를 변화시키기 위해 수행하는 작업 단위로 하나의 작업을 위해 더 이상 분할될 수 없는 한꺼번에 수행되어야 할 작업들의 집합을 의미한다. 트랜잭션은 여러 개의 클라이언트가 동시에 데이터에 액세스 하거나 프로그램이 데이터를 수정하는 과정에서 데이터 부정합을 방지하고자 하는 목적으로 사용되며 데이터베이스에서 이 트랜잭션을 조작함으로써 사용자가 데이터베이스에 대한 완전성을 신뢰할 수 있도록 한다.

<br>

> **[ 데이터베이스 트랜잭션 관리 ]** <br>
> 데이터베이스는 트랜잭션 관리를 위한 설정을 가지고 있다. 데이터베이스는 명령을 끝낼때까지 수행 내역을 로그에 저장한다. 데이터베이스에 반영된 내용을 재반영하기 위한 `read log`와 수행을 실패의 이전의 상태로 되돌리는 `undo log`를 이용해 트랜잭션을 지원한다.

<br>

### 트랜잭션의 특징

- 원자성 - 트랜잭션이 모두 DB에 반영되거나 혹은 전혀 반영되지 않아야 한다.
- 일관성 - 트랜잭션의 작업처리 결과는 항상 일관성이 있어야 한다.
- 독립성 - 둘 이상의 트랜잭션이 동시에 실행되고 있을 때 어떠한 트랜잭션도 다른 트랜잭션의 작업에 영향을 미칠 수 없다.
- 지속성 - 트랜잭션이 성공적으로 완료되었으면 결과는 영구적으로 반영되어야 한다.

<br>

### Spring 과 Transaction

데이터베이스에서는 각각의 명령을 하나의 트랜잭션으로 보고 보장해주기 때문에 여러 명령을 하나의 트랜잭션으로 묶고싶은경우 개발자가 직접 트랜잭션 경계설정을 통해 여러 명령을 하나의 트랜잭션으로 명시하는 일이 필요하다. 하지만, 비즈니스 로직과 트랜잭션 처리 로직이 동시에 존재한다면 코드의 중복이 생길 수 있고 비즈니스 로직 작성에만 집중하기 어렵다 비즈니스 로직에 집중하기 위해 스프링은 크게 2가지 트랜잭션 적용 기술을 지원해준다.

<br>

### TransactionTemplate

데이터 접근 기술에는 Jdbc, JPA 등 여러가지가 존재한다. 기술이 바뀌면 트랜잭션을 사용하는 방법도 달라진다. 이러한 상황을 고려하여 스프링은 트랜잭션에 대한 추상화를 `PlatformTransactionManager` 통해 지원한다.

`PlatformTransactionManager`는 `DataSource`에 맞게 트랜잭션을 관리할 수 있게 기능을 제공하고 있다. `PlatformTransactionManager` 는 `getTransaction`, `rollback`, `commit` 으로 구성되어 있다.

`getTransaction` 메서드를 통해서 파라미터로 전달되는 `TransactionDefinition`에 따라 트랜잭션을 시작한다. 트랜잭션을 문제없이 완료하면 `commit` 을 문제가 발생하면 `rollback` 을 호출한다. `getTransaction` 트랜잭션부터 `commit` 또는 `rollback` 을 하는 부분까지 트랜잭션 경계설정이다.

스프링은 `PlatformTransactionManager` 의 구현체로 `JDBC`에 사용되는 `DataSourceTransactionManager` 그리고 `JPA`에 사용되는 `JpaTransactionManager` 를 제공한다. 이 두 구현체는 하나의 데이터베이스를 사용하거나 각각의 데이터를 독립적으로 사용하는 로컬 트랜잭션의 경우 사용할 수 있다.

만약, 하나 이상의 데이터베이스가 사용되는 경우라면 글로벌 트랜잭션에 해당되는 `JtaTransactionManager`를 사용할 수 있다. 여러 개의 데이터베이스에 대한 작업을 하나의 트랜잭션으로 묶을 수 있고 다른 서버에 분산된 작업도 묶을 수 있다.

이렇게 직접적으로 코드에 구현하는 트랜잭션 방식 외에도 스프링은 `AOP`를 이용한 선언적 트랜잭션을 제공한다. 선언적 트랜잭션은 `tx 네임스페이스`를 이용하는 방법과 어노테이션을 기반으로 설정하는 방법이 있다.

<br>

### 선언적 트랜잭션

`tx 네임스페이스를 이용하는 방법`은 `Bean 설정 파일`에서 트랜잭션 매니저를 등록하고 속성과 대상을 정의해 트랜잭션을 적용하겠다고 명시하는 방법이다. 이렇게 적용하면 코드에는 영향을 주지 않고 일괄적으로 트랜잭션을 적용하고 변경할 수 있다.

`어노테이션을 기반으로 트랜잭션을 설정하는 방법`은 트랜잭션 어노테이션을 메서드, 클래스, 인터페이스에 적용하여 사용할 수 있다. 클래스 상단에 존재하는 어노테이션에 대해서는 해당 클래스에 존재하는 모든메서드에 어노테이션이 적용된다.

중첩되어 존재하는 경우에는 클래스 메서드 → 클래스 → 인터페이스 메서드 → 인터페이스 순으로 우선순위를 가지고 적용된다. 어노테이션이 적용된 메서드는 메서드 시작부터 트랜잭션이 시작되고 메서를 성공적으로 완료하면 트랜잭션 커밋 도중에 문제가 발생하면 롤백과정이 진행된다.

<br>

### [ Reference ]

[[10분 테코톡] 🐤 샐리의 트랜잭션](https://www.youtube.com/watch?v=aX9c7z9l_u8)
